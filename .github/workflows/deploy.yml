name: Deploy to Aliyun

on:
  push:
    branches: ['master']

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Aliyun
  run: |
    # 设置 SSH 配置
    mkdir -p ~/.ssh
    echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa

    # 验证私钥格式
    if ! ssh-keygen -l -f ~/.ssh/id_rsa &>/dev/null; then
      echo "::error::Invalid SSH private key format"
      exit 1
    fi

    # 添加服务器到 known_hosts
    ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts

    # 测试 SSH 连接
    if ! ssh -o BatchMode=yes -p $SSH_PORT $SSH_USER@$SERVER_IP "echo SSH connection successful"; then
      echo "::error::Failed to establish SSH connection"
      exit 1
    fi

    # 执行部署
    rsync -avz -e "ssh -p $SSH_PORT" \
      --exclude='.github/' \
      --exclude='.git/' \
      --exclude='node_modules/' \
      ./ \
      $SSH_USER@$SERVER_IP:$DEPLOY_PATH

    # 验证部署
    ssh -p $SSH_PORT $SSH_USER@$SERVER_IP "
      ls -la $DEPLOY_PATH
      # 添加其他验证命令
    "
  env:
    SSH_PRIVATE_KEY: ${{ secrets.ALIYUN_SSH_KEY }}
    SSH_USER: ${{ secrets.ALIYUN_SSH_USER }}
    SERVER_IP: ${{ secrets.ALIYUN_SERVER_IP }}
    SSH_PORT: ${{ secrets.ALIYUN_SSH_PORT || '22' }}
    DEPLOY_PATH: ${{ secrets.ALIYUN_DEPLOY_PATH }}
