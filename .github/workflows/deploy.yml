name: Deploy Application

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Create oss.json
        run: |
          cat > config/oss.json <<EOF
             {
               "OSS": {
                   "accessKeyId": "${{ secrets.OSS_KEY_ID }}",
                   "accessKeySecret": "${{ secrets.OSS_KEY_SECRET}}",
                   "region": "oss-cn-hangzhou",
                   "bucket": "yqq-img"
                }
             }
          EOF

      - name: Setup auth
        run: |
          cat > config/auth.json <<EOF
          {
            "auth":{
             "secret":"${{ secrets.AUTH }}"
             }
          }
          EOF

      - name: Build project
        run: |
          echo "å¼€å§‹æ„å»ºé¡¹ç›®..."
          npm run build
        env:
          NODE_ENV: production

      - name: Run tests (if available)
        run: |
          # å¦‚æœæœ‰æµ‹è¯•è„šæœ¬å°±è¿è¡Œï¼Œæ²¡æœ‰å°±è·³è¿‡
          if [ -f package.json ] && npm run | grep -q "test"; then
            echo "è¿è¡Œæµ‹è¯•..."
            npm test
          else
            echo "æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•è„šæœ¬ï¼Œè·³è¿‡æµ‹è¯•"
          fi

      - name: Type check (if available)
        run: |
          # å¦‚æœæœ‰TypeScriptæ£€æŸ¥å°±è¿è¡Œ
          if [ -f package.json ] && npm run | grep -q "type-check"; then
            echo "è¿è¡Œç±»å‹æ£€æŸ¥..."
            npm run type-check
          else
            echo "æ²¡æœ‰ç±»å‹æ£€æŸ¥è„šæœ¬ï¼Œè·³è¿‡"
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.ALIYUN_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ secrets.ALIYUN_SERVER_PORT }} ${{ secrets.ALIYUN_SERVER_IP }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Verify SSH connection
        run: |
          ssh -i ~/.ssh/id_ed25519 -o ConnectTimeout=10 -p ${{ secrets.ALIYUN_SERVER_PORT }} ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_SERVER_IP }} "echo 'SSHè¿æ¥æˆåŠŸ'"

      - name: Sync code to server
        run: |
          echo "åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨..."
          rsync -avz --delete --exclude='node_modules' --exclude='.git' -e "ssh -i ~/.ssh/id_ed25519 -p ${{ secrets.ALIYUN_SERVER_PORT }}" ./ ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_SERVER_IP }}:/root/nest-app/

      - name: Pre-deployment check
        run: |
          echo "æ£€æŸ¥æœåŠ¡å™¨å½“å‰çŠ¶æ€..."
          ssh -i ~/.ssh/id_ed25519 -p ${{ secrets.ALIYUN_SERVER_PORT }} ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_SERVER_IP }} "
            echo 'å½“å‰å·¥ä½œç›®å½•:'
            pwd
            echo 'æ£€æŸ¥ç›®æ ‡ç›®å½•:'
            ls -la /root/nest-app/ || echo 'ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»º'
            echo 'DockerçŠ¶æ€:'
            docker ps
          "

      - name: Deploy with Docker Compose
        run: |
          echo "å¼€å§‹éƒ¨ç½²åº”ç”¨..."
          ssh -i ~/.ssh/id_ed25519 -p ${{ secrets.ALIYUN_SERVER_PORT }} ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_SERVER_IP }} "
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            
            echo 'åˆ‡æ¢åˆ°åº”ç”¨ç›®å½•...'
            cd /root/nest-app/
            
            echo 'åœæ­¢ç°æœ‰å®¹å™¨...'
            docker-compose down || echo 'æ²¡æœ‰è¿è¡Œä¸­çš„å®¹å™¨'
            
            echo 'æ„å»ºæ–°é•œåƒ...'
            docker-compose build --no-cache
            
            echo 'å¯åŠ¨æ–°å®¹å™¨...'
            docker-compose up -d
            
            echo 'ç­‰å¾…å®¹å™¨å¯åŠ¨...'
            sleep 10
            
            echo 'æ£€æŸ¥å®¹å™¨çŠ¶æ€...'
            docker-compose ps
            
            echo 'éƒ¨ç½²å®Œæˆ!'
          "

      - name: Health check
        run: |
          echo "è¿›è¡Œå¥åº·æ£€æŸ¥..."
          ssh -i ~/.ssh/id_ed25519 -p ${{ secrets.ALIYUN_SERVER_PORT }} ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_SERVER_IP }} "
            echo '=== Dockerå®¹å™¨çŠ¶æ€ ==='
            docker ps
            
            echo '=== åº”ç”¨å¥åº·æ£€æŸ¥ ==='
            max_attempts=10
            attempt=1
            while [ \$attempt -le \$max_attempts ]; do
              if curl -f http://localhost:8889/health 2>/dev/null; then
                echo 'åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡!'
                break
              else
                echo \"å°è¯• \$attempt/\$max_attempts: åº”ç”¨å°šæœªå°±ç»ªï¼Œç­‰å¾…10ç§’...\"
                sleep 10
                attempt=\$((attempt + 1))
              fi
            done
            
            if [ \$attempt -gt \$max_attempts ]; then
              echo 'å¥åº·æ£€æŸ¥å¤±è´¥!'
              exit 1
            fi
          "

      - name: Deployment success
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆ!"
          echo "åº”ç”¨å·²æ­£å¸¸è¿è¡Œåœ¨æœåŠ¡å™¨ä¸Š"
